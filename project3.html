<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS 180 Project 3: Face Morphing</title>
    <script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
    <style>
        body {
            background-color: #FFFAF0;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1, h2, h3 {
            color: #333;
        }
        .image-container {
            background-color: #E0FFFF;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
        }
        img {
            display: block;
            margin-left: auto;
            margin-right: auto;
            max-width: 100%; /* Ensures images fit within the container */
            height: auto; /* Maintains aspect ratio */
        }
        .gif {
            animation: loop 1s infinite; /* Ensures the GIF loops */
        }
        @keyframes loop {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <h1>CS 180 Project 3: Face Morphing</h1>
    
    <h2>Part 1: Defining Correspondences</h2>
    <p>I used the provided online tool to select keypoints for both <em>myself.jpg</em> and <em>george_small.jpg</em>. I also added the corners of the images as additional keypoints for better performance.</p>
    <div class="image-container">
        <img src="project3_data/part1_keypoints.png" alt="Keypoints">
        <img src="project3_data/part1_points_lines.png" alt="Delaunay Triangulation">
    </div>
    
    <h2>Part 2: Computing the "Mid-way Face"</h2>
    <p>This part requires aligning the input image to a set of target points' average positions through an affine transformation. The process consists of the following steps:</p>
    <ol>
        <li>Triangulation: Perform triangulation on the source points and target points to execute affine transformations within each triangle.</li>
        <li>Bounding Rectangle Extraction: For each triangle, calculate the minimum bounding rectangle that contains the triangle and extract the image region within this rectangle.</li>
        <li>Affine Transformation Matrix Calculation: Compute the affine transformation matrix based on the vertices of the source triangle and the target triangle. The affine transformation can be represented as:
            <br>
            $$ 
            \begin{bmatrix}
                x' \\
                y' \\
                1
            \end{bmatrix}
            =
            \begin{bmatrix}
                a & b & 0 \\
                c & d & 0 \\
                0 & 0 & 1
            \end{bmatrix}
            \begin{bmatrix}
                x \\
                y \\
                1
            \end{bmatrix}
            $$
        </li>
        <li>Applying Affine Transformation: Use <code>cv2.warpAffine</code> to apply the affine transformation to the extracted rectangular image region, yielding the transformed image region.</li>
        <li>Mask Generation and Composition: Create a mask for the target rectangular region to ensure that only the transformed area is composed into the corresponding position of the target image.</li>
    </ol>
    <p>- The matrix form of affine transformation: $$tx$$ and $$ty$$ are the translation vectors.</p>
    <p>$$
    \begin{bmatrix}
        x' \\
        y'
    \end{bmatrix}
    =
    \begin{bmatrix}
        a & b \\
        c & d
    \end{bmatrix}
    \begin{bmatrix}
        x \\
        y
    \end{bmatrix}
    +
    \begin{bmatrix}
        tx \\
        ty
    \end{bmatrix}
    $$</p>
    <p>- Calculation of the bounding rectangle coordinates: $$i = 1, 2, 3$$ represents the three vertices of the triangle.</p>
    <p>$$
    \text{src_rect} = \left(\min(x_i), \min(y_i), \max(x_i) - \min(x_i), \max(y_i) - \min(y_i)\right)
    $$</p>
    <div class="image-container">
        <img src="project3_data/part2.png" alt="Mid-way Face Computation">
    </div>

    <h2>Part 3: The Morph Sequence</h2>
    <p>Using a range of weights in [0, 1], I created a morph sequence:</p>
    <div class="image-container">
        <img id="morphGif" class="gif" src="project3_data/blended_faces.gif" alt="Morph Sequence">
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var gif = document.getElementById("morphGif");
            gif.addEventListener("load", function() {
                var gifDuration = 10000;
                setTimeout(function() {
                    gif.src = "";
                }, gifDuration);
            });
        });
    </script>

    <h2>Part 4: The "Mean Face" of a Population</h2>
    <p>I used the FEI <a href="https://fei.edu.br/~cet/facedatabase.html">Face Database</a> with 200 faces to compute the average face.</p>
    <div class="image-container">
        <img src="project3_data/part4_1.png" alt="Sample Faces from Dataset">
        <img src="project3_data/part4_2.png" alt="Average Keypoints">
        <img src="project3_data/part4_3.png" alt="Warped Faces to Average Shape">
        <img src="project3_data/part4_4.png" alt="Average Face of the Dataset">
    </div>
    <p>I also performed the same operation to my own face with the average face:</p>
    <div class="image-container">
        <img src="project3_data/part4_5.png" alt="My Face Warped into Average Geometry">
    </div>

    <h2>Part 5: Caricatures: Extrapolating from the Mean</h2>
    <p>Produced a caricature of my face by extrapolating from the population mean I calculated in the last step. I achieved this by choosing $\alpha > 1$, I chose <code>alpha = 1.5</code>.</p>
    <div class="image-container">
        <img src="project3_data/part5.png" alt="Caricature of My Face">
    </div>

    <h2>Bells and Whistles: Gender Change</h2>
    <p>I changed the gender of my face using the average face found on <a href="https://www.pinterest.com/pin/241998179952235711">Pinterest</a>.</p>
    <div class="image-container">
        <img src="project3_data/bells.png" alt="Gender Change Image 1">
        <img src="project3_data/bells2.png" alt="Gender Change Image 2">
    </div>
</body>
</html>
